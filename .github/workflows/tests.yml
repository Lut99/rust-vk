# TEST.yml
#   by Lut99
# 
# A Github action that automatically runs tests upon each new commit or pull request.

name: Continious integration
on:
  push:
    branches:
    - main
    - 'releases/**'
  pull_request:

jobs:
  test:
    name: Run Cargo tests
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install cmake
      run: |
        apt-get update && apt-get install cmake
    - uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.204.0
        vulkan-components: Vulkan-Headers, Vulkan-Loader
        vulkan-use-cache: true
    - name: Install Google's SwiftShader
      run: |
        git clone https://github.com/google/swiftshader.git &&
        cd swiftshader &&
        mkdir build &&
        cd build &&
        cmake ../ &&
        cmake --build . --parallel &&
        cd ../..
    - uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
    - name: Run Cargo tests
      run: |
        LD_LIBRARY_PATH="$LD_LIBRARY_PATH:./swiftshader/build"
        cargo test
    # - uses: actions-rs/cargo@v1
    #   with:
    #     command: test
